<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bill Tracker Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

<h1 class="text-2xl font-bold mb-4">ðŸ’° Bill Tracker</h1>

<!-- Add Bill Form -->
<div class="bg-white shadow rounded p-4 w-full max-w-md mb-6">
    <h2 class="font-semibold mb-2">Add New Bill</h2>
    <input id="title" placeholder="Title" class="border p-2 w-full mb-2 rounded">
    <input id="amount" type="number" placeholder="Amount" class="border p-2 w-full mb-2 rounded">
    <input id="due_date" type="date" class="border p-2 w-full mb-2 rounded">
    <input id="category" placeholder="Category" class="border p-2 w-full mb-2 rounded">
    <button onclick="addBill()" class="bg-blue-500 text-white p-2 rounded w-full">Add Bill</button>
</div>

<!-- Bills Dashboard -->
<div class="bg-white shadow rounded p-4 w-full max-w-md">
    <h2 class="font-semibold mb-2">Your Bills</h2>
    <div id="billsList"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

// Fetch list of bills from bot
function listBills() {
    tg.sendData(JSON.stringify({action:"list_bills"}));
}

// Add a bill
function addBill() {
    const billData = {
        action: "add_bill",
        title: document.getElementById("title").value,
        amount: parseFloat(document.getElementById("amount").value),
        due_date: document.getElementById("due_date").value,
        category: document.getElementById("category").value
    };
    tg.sendData(JSON.stringify(billData));
}

// Mark a bill as paid
function markPaid(bill_id) {
    tg.sendData(JSON.stringify({action:"mark_paid", bill_id}));
}

// Handle bot responses
tg.onEvent("message", (msg) => {
    if (!msg.data) return;
    try {
        const response = JSON.parse(msg.data);

        if(response.status === "success") {
            // If it contains bills, render dashboard
            if(response.bills) {
                renderBills(response.bills);
            }
            // If a single bill action, refresh list
            else if(response.bill) {
                listBills();
            }
        } else {
            alert("Error: " + response.error);
        }
    } catch(e) {
        console.error("Invalid JSON from bot:", msg.data);
    }
});

// Render bills in dashboard
function renderBills(bills) {
    const container = document.getElementById("billsList");
    container.innerHTML = "";

    if(bills.length === 0){
        container.innerHTML = "<p class='text-gray-500'>No bills added yet.</p>";
        return;
    }

    bills.forEach(bill => {
        const statusColor = bill.status === "paid" ? "green" : "red";
        const div = document.createElement("div");
        div.className = "border p-2 mb-2 rounded flex justify-between items-center";
        div.innerHTML = `
            <div>
                <p class="font-semibold">${bill.title}</p>
                <p class="text-sm text-gray-600">${bill.category} | Due: ${bill.due_date}</p>
                <p class="text-${statusColor}-500 font-semibold">${bill.status.toUpperCase()}</p>
            </div>
            <div>
                ${bill.status === "unpaid" ? `<button onclick='markPaid("${bill.id}")' class="bg-green-500 text-white px-2 py-1 rounded">Mark Paid</button>` : ""}
            </div>
        `;
        container.appendChild(div);
    });
}

// Initial load
listBills();
</script>


</body>
</html>
